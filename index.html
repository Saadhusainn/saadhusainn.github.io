<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sijjeen - Book Collage Maker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Amiri', 'Scheherazade New', serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            .container {
                padding: 40px;
            }
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .title {
            color: #667eea;
            font-size: 2em;
            font-weight: bold;
        }
        
        @media (min-width: 768px) {
            .title {
                font-size: 2.5em;
            }
        }
        
        .durood {
            color: #667eea;
            font-size: 0.9em;
            text-align: right;
            line-height: 1.8;
            direction: rtl;
            max-width: 300px;
        }
        
        @media (min-width: 768px) {
            .durood {
                font-size: 1.1em;
            }
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        
        @media (min-width: 768px) {
            .subtitle {
                margin-bottom: 30px;
                font-size: 1em;
            }
        }
        
        .search-bar {
            max-width: 600px;
            margin: 0 auto 20px;
            position: relative;
        }
        
        @media (min-width: 768px) {
            .search-bar {
                margin-bottom: 30px;
            }
        }
        
        .search-bar input {
            width: 100%;
            padding: 12px 50px 12px 15px;
            font-size: 16px;
            border: 2px solid #667eea;
            border-radius: 50px;
            outline: none;
            font-family: 'Amiri', 'Scheherazade New', serif;
        }
        
        @media (min-width: 768px) {
            .search-bar input {
                padding: 15px 50px 15px 20px;
            }
        }
        
        .search-bar input:focus {
            border-color: #764ba2;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #667eea;
            font-size: 18px;
        }
        
        @media (min-width: 768px) {
            .search-icon {
                right: 20px;
                font-size: 20px;
            }
        }
        
        .books-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 20px;
            padding: 5px;
        }
        
        @media (min-width: 768px) {
            .books-list {
                max-height: 400px;
                margin-bottom: 30px;
                padding: 10px;
            }
        }
        
        .book-item {
            padding: 12px 15px;
            margin: 5px 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            text-align: left;
            direction: ltr;
        }
        
        @media (min-width: 768px) {
            .book-item {
                padding: 15px 20px;
            }
        }
        
        .book-item:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateX(5px);
        }
        
        .book-item.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
            font-weight: bold;
        }
        
        .collage-settings {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        @media (min-width: 768px) {
            .collage-settings {
                padding: 25px;
                margin-bottom: 30px;
            }
        }
        
        .setting-group {
            margin-bottom: 15px;
        }
        
        @media (min-width: 768px) {
            .setting-group {
                margin-bottom: 20px;
            }
        }
        
        .setting-group label {
            display: block;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 15px;
        }
        
        @media (min-width: 768px) {
            .setting-group label {
                font-size: 16px;
            }
        }
        
        .page-count-btns {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        @media (min-width: 768px) {
            .page-count-btns {
                gap: 10px;
            }
        }
        
        .page-count-btn {
            padding: 8px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            font-family: 'Amiri', 'Scheherazade New', serif;
        }
        
        @media (min-width: 768px) {
            .page-count-btn {
                padding: 10px 25px;
                font-size: 16px;
            }
        }
        
        .page-count-btn:hover {
            background: #f0f4ff;
        }
        
        .page-count-btn.active {
            background: #667eea;
            color: white;
        }
        
        .page-inputs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        @media (min-width: 768px) {
            .page-inputs {
                gap: 15px;
            }
        }
        
        .page-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        @media (min-width: 768px) {
            .page-input-group {
                gap: 10px;
            }
        }
        
        .page-input-group span {
            font-size: 14px;
        }
        
        .page-input-group input {
            padding: 8px;
            font-size: 14px;
            border: 2px solid #667eea;
            border-radius: 8px;
            width: 70px;
            text-align: center;
            font-family: 'Amiri', 'Scheherazade New', serif;
        }
        
        @media (min-width: 768px) {
            .page-input-group input {
                padding: 10px;
                font-size: 16px;
                width: 80px;
            }
        }
        
        .preview-btn {
            background: #667eea;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            font-family: 'Amiri', 'Scheherazade New', serif;
        }
        
        @media (min-width: 768px) {
            .preview-btn {
                padding: 10px 30px;
                font-size: 16px;
            }
        }
        
        .preview-btn:hover {
            background: #764ba2;
        }
        
        .preview-section {
            text-align: center;
            margin-top: 20px;
        }
        
        @media (min-width: 768px) {
            .preview-section {
                margin-top: 30px;
            }
        }
        
        .preview-container {
            display: inline-block;
            margin: 20px 0;
            max-width: 100%;
            overflow-x: auto;
        }
        
        .preview-canvas {
            border: 3px solid #667eea;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: block;
            max-width: 100%;
            height: auto;
        }
        
        .download-btn {
            background: #28a745;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 15px;
            transition: all 0.3s;
            font-family: 'Amiri', 'Scheherazade New', serif;
        }
        
        @media (min-width: 768px) {
            .download-btn {
                padding: 15px 40px;
                font-size: 18px;
                margin-top: 20px;
            }
        }
        
        .download-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .hidden {
            display: none;
        }
        
        .info-text {
            color: #666;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .error-message {
            background: #fee;
            border: 2px solid #fcc;
            color: #c33;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .no-results {
            text-align: center;
            padding: 30px;
            color: #999;
            font-size: 16px;
        }
        
        @media (min-width: 768px) {
            .no-results {
                padding: 40px;
                font-size: 18px;
            }
        }
        
        .loading {
            text-align: center;
            color: #667eea;
            font-size: 16px;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">📚 Sijjeen</div>
            <div class="durood">
                اللَّهُمَّ صَلِّ عَلَى مُحَمَّدٍ وَعَلَى آلِ مُحَمَّدٍ<br>
                كَمَا صَلَّيْتَ عَلَى إِبْرَاهِيمَ وَعَلَى آلِ إِبْرَاهِيمَ<br>
                إِنَّكَ حَمِيدٌ مَجِيدٌ
            </div>
        </div>
        <p class="subtitle">Create beautiful book collages</p>
        
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search books..." oninput="searchBooks()">
            <span class="search-icon">🔍</span>
        </div>
        
        <h2 style="color: #667eea; margin-bottom: 15px; font-size: 1.3em;">Select a Book</h2>
        <div id="booksList" class="books-list">
            <div class="loading">Loading books...</div>
        </div>
        
        <div id="errorContainer"></div>
        
        <div id="collageSettings" class="collage-settings hidden">
            <div class="setting-group">
                <label>How many pages do you want in your collage?</label>
                <div class="page-count-btns">
                    <button class="page-count-btn active" onclick="setPageCount(2)">2 Pages</button>
                    <button class="page-count-btn" onclick="setPageCount(3)">3 Pages</button>
                    <button class="page-count-btn" onclick="setPageCount(4)">4 Pages</button>
                </div>
            </div>
            
            <div class="setting-group">
                <label>Select page numbers:</label>
                <div id="pageInputs" class="page-inputs"></div>
            </div>
            
            <p class="info-text" id="pageInfo"></p>
        </div>
        
        <div id="previewSection" class="preview-section hidden">
            <h2 style="color: #667eea; margin-bottom: 20px; font-size: 1.3em;">Preview</h2>
            <div class="preview-container">
                <canvas id="previewCanvas" class="preview-canvas"></canvas>
            </div>
            <br>
            <button class="download-btn" onclick="downloadCollage()">💾 Download Collage</button>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // ADD YOUR BOOKS HERE
        const booksList = [
            { name: "مسند أحمد بن حنبل ج 3", file: "books/maih_3.pdf" },
            { name: "الطبقات الكبرى لابن سعد ج 1", file: "http://ddl.safone.co/4283034/A66aba9at_01.pdf?hash=AgADhR"},
        ];
        
        let books = [];
        let selectedBook = null;
        let pageCount = 2;
        
        function showError(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `<div class="error-message">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
        
        async function loadBooks() {
            try {
                for (let bookInfo of booksList) {
                    try {
                        const pdf = await pdfjsLib.getDocument(bookInfo.file).promise;
                        books.push({
                            name: bookInfo.name,
                            pdf: pdf,
                            file: bookInfo.file
                        });
                    } catch (error) {
                        console.log(`Could not load ${bookInfo.name}:`, error);
                    }
                }
                displayBooks(books);
            } catch (error) {
                showError('Error loading books. Please refresh the page.');
                console.error('Load books error:', error);
            }
        }
        
        function displayBooks(booksToDisplay) {
            const list = document.getElementById('booksList');
            list.innerHTML = '';
            
            if (booksToDisplay.length === 0) {
                list.innerHTML = '<div class="no-results">No books found</div>';
                return;
            }
            
            booksToDisplay.forEach((book) => {
                const item = document.createElement('div');
                item.className = 'book-item';
                item.textContent = book.name;
                item.onclick = () => selectBook(book);
                list.appendChild(item);
            });
        }
        
        function searchBooks() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = books.filter(book => 
                book.name.toLowerCase().includes(query)
            );
            displayBooks(filtered);
        }
        
        function selectBook(book) {
            try {
                selectedBook = book;
                
                const items = document.querySelectorAll('.book-item');
                items.forEach(item => {
                    if (item.textContent === book.name) {
                        item.classList.add('selected');
                    } else {
                        item.classList.remove('selected');
                    }
                });
                
                document.getElementById('collageSettings').classList.remove('hidden');
                document.getElementById('pageInfo').textContent = `This book has ${book.pdf.numPages} pages`;
                
                updatePageInputs();
                updatePreview();
            } catch (error) {
                showError('Error selecting book. Please try again.');
                console.error('Select book error:', error);
            }
        }
        
        function setPageCount(count) {
            try {
                pageCount = count;
                
                const buttons = document.querySelectorAll('.page-count-btn');
                buttons.forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                
                updatePageInputs();
                updatePreview();
            } catch (error) {
                showError('Error changing page count.');
                console.error('Set page count error:', error);
            }
        }
        
        function updatePageInputs() {
            if (!selectedBook) return;
            
            try {
                const container = document.getElementById('pageInputs');
                container.innerHTML = '';
                
                for (let i = 1; i <= pageCount; i++) {
                    const group = document.createElement('div');
                    group.className = 'page-input-group';
                    
                    const label = document.createElement('span');
                    label.textContent = `Page ${i}:`;
                    
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.id = `page${i}`;
                    input.min = '1';
                    input.max = selectedBook.pdf.numPages;
                    input.value = i;
                    input.onchange = updatePreview;
                    
                    group.appendChild(label);
                    group.appendChild(input);
                    container.appendChild(group);
                }
            } catch (error) {
                showError('Error updating page inputs.');
                console.error('Update page inputs error:', error);
            }
        }
        
        async function updatePreview() {
            if (!selectedBook) return;
            
            try {
                const pageNumbers = [];
                for (let i = 1; i <= pageCount; i++) {
                    const input = document.getElementById(`page${i}`);
                    if (!input) return;
                    
                    const pageNum = parseInt(input.value);
                    if (isNaN(pageNum) || pageNum < 1 || pageNum > selectedBook.pdf.numPages) {
                        showError(`Page ${i} must be between 1 and ${selectedBook.pdf.numPages}`);
                        return;
                    }
                    pageNumbers.push(pageNum);
                }
                
                const pages = [];
                for (let pageNum of pageNumbers) {
                    const page = await selectedBook.pdf.getPage(pageNum);
                    pages.push(page);
                }
                
                // Maximum quality scale
                const scale = 3;
                const viewports = pages.map(page => page.getViewport({scale}));
                
                const canvas = document.getElementById('previewCanvas');
                const ctx = canvas.getContext('2d');
                
                // Calculate actual canvas size without constraints
                const totalWidth = viewports.reduce((sum, vp) => sum + vp.width, 0);
                const maxHeight = Math.max(...viewports.map(vp => vp.height));
                
                // Set canvas to actual size for maximum quality
                canvas.width = totalWidth;
                canvas.height = maxHeight;
                
                // White background
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Render each page at full quality
                let xOffset = 0;
                for (let i = 0; i < pages.length; i++) {
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = viewports[i].width;
                    tempCanvas.height = viewports[i].height;
                    
                    await pages[i].render({
                        canvasContext: tempCanvas.getContext('2d'),
                        viewport: viewports[i]
                    }).promise;
                    
                    ctx.drawImage(tempCanvas, xOffset, 0);
                    xOffset += viewports[i].width;
                }
                
                document.getElementById('previewSection').classList.remove('hidden');
            } catch (error) {
                showError('Error creating preview. Please check your page numbers.');
                console.error('Update preview error:', error);
            }
        }
        
        function downloadCollage() {
            try {
                const canvas = document.getElementById('previewCanvas');
                const link = document.createElement('a');
                link.download = 'sijjeen-collage.png';
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();
            } catch (error) {
                showError('Error downloading collage. Please try again.');
                console.error('Download error:', error);
            }
        }
        
        loadBooks();
    </script>
</body>
</html>
