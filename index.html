<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sijjeen - Book Collage Maker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Amiri', 'Scheherazade New', serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            touch-action: manipulation;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .title {
            color: #667eea;
            font-size: 2em;
            font-weight: bold;
        }
        
        .durood {
            color: #667eea;
            font-size: 0.9em;
            text-align: right;
            line-height: 1.8;
            direction: rtl;
            max-width: 300px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        
        .search-bar {
            max-width: 600px;
            margin: 0 auto 20px;
            position: relative;
        }
        
        .search-bar input {
            width: 100%;
            padding: 12px 50px 12px 15px;
            font-size: 16px;
            border: 2px solid #667eea;
            border-radius: 50px;
            outline: none;
            font-family: 'Amiri', 'Scheherazade New', serif;
        }
        
        .search-bar input:focus {
            border-color: #764ba2;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #667eea;
            font-size: 18px;
        }
        
        .books-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 20px;
            padding: 5px;
        }
        
        .book-item {
            padding: 12px 15px;
            margin: 5px 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            text-align: left;
        }
        
        .book-item:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateX(5px);
        }
        
        .book-item.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
            font-weight: bold;
        }
        
        .book-folder {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
        }
        
        .book-meta {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
            line-height: 1.4;
        }
        
        .volume-count {
            font-size: 0.8em;
            color: #666;
            margin-left: 10px;
        }
        
        .volumes-list {
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin: 10px 0;
            padding: 5px;
        }
        
        .volume-item {
            padding: 10px 15px;
            margin: 3px 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .volume-item:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateX(3px);
        }
        
        .volume-item.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .collage-settings {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            animation: fadeInUp 0.5s ease-out;
        }
        
        .setting-group {
            margin-bottom: 15px;
        }
        
        .setting-group label {
            display: block;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 15px;
        }
        
        .page-count-btns {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .page-count-btn {
            padding: 8px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            font-family: 'Amiri', 'Scheherazade New', serif;
        }
        
        .page-count-btn:hover {
            background: #f0f4ff;
            transform: translateY(-2px);
        }
        
        .page-count-btn.active {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }
        
        .page-inputs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            animation: fadeIn 0.5s ease-out;
        }
        
        .page-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .page-input-group span {
            font-size: 14px;
        }
        
        .page-input-group input {
            padding: 8px;
            font-size: 14px;
            border: 2px solid #667eea;
            border-radius: 8px;
            width: 70px;
            text-align: center;
            font-family: 'Amiri', 'Scheherazade New', serif;
            transition: all 0.3s;
        }
        
        .page-input-group input:focus {
            border-color: #764ba2;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }
        
        .preview-section {
            text-align: center;
            margin-top: 20px;
            animation: fadeInUp 0.5s ease-out;
        }
        
        .preview-container {
            display: inline-block;
            margin: 20px 0;
            max-width: 100%;
            overflow-x: auto;
            position: relative;
            -webkit-overflow-scrolling: touch;
        }
        
        .preview-canvas {
            border: 3px solid #667eea;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: block;
            max-width: 100%;
            height: auto;
        }
        
        .highlight-canvas {
            position: absolute;
            top: 0;
            left: 0;
            border: 3px solid #667eea;
            border-radius: 10px;
            cursor: crosshair;
            touch-action: none;
        }
        
        .download-btn {
            background: #28a745;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 15px;
            transition: all 0.3s;
            font-family: 'Amiri', 'Scheherazade New', serif;
        }
        
        .download-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .hidden {
            display: none;
        }
        
        .info-text {
            color: #666;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .error-message {
            background: #fee;
            border: 2px solid #fcc;
            color: #c33;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            animation: shake 0.5s ease-in-out;
        }
        
        .success-message {
            background: #efe;
            border: 2px solid #cfc;
            color: #363;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            animation: bounceIn 0.5s ease-out;
        }
        
        .no-results {
            text-align: center;
            padding: 30px;
            color: #999;
            font-size: 16px;
        }
        
        .loading {
            text-align: center;
            color: #667eea;
            font-size: 16px;
            padding: 20px;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 10px;
        }
        
        .highlight-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 15px;
            margin: 15px 0;
            animation: fadeInUp 0.5s ease-out;
        }
        
        .highlight-colors {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .color-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .color-btn:hover {
            transform: scale(1.1);
        }
        
        .color-btn.active {
            border-color: #333;
            transform: scale(1.2);
        }
        
        .highlight-yellow {
            background-color: #ffff00;
        }
        
        .highlight-red {
            background-color: #ff0000;
        }
        
        .highlight-cyan {
            background-color: #00ffff;
        }
        
        .highlight-lime {
            background-color: #00ff00;
        }
        
        .highlight-instructions {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
            text-align: center;
        }
        
        .highlight-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            font-family: 'Amiri', 'Scheherazade New', serif;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
        }
        
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .clear-btn {
            background: #dc3545;
            color: white;
        }
        
        .clear-btn:hover {
            background: #c82333;
        }
        
        .toggle-btn {
            background: #6c757d;
            color: white;
        }
        
        .toggle-btn:hover {
            background: #5a6268;
        }
        
        .undo-btn {
            background: #ffc107;
            color: black;
        }
        
        .undo-btn:hover {
            background: #e0a800;
        }
        
        .redo-btn {
            background: #17a2b8;
            color: white;
        }
        
        .redo-btn:hover {
            background: #138496;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
           100% { transform: rotate(360deg); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">📚 Sijjeen</div>
            <div class="durood">
                اللَّهُمَّ صَلِّ عَلَى مُحَمَّدٍ وَعَلَى آلِ مُحَمَّدٍ<br>
                كَمَا صَلَّيْتَ عَلَى إِبْرَاهِيمَ وَعَلَى آلِ إِبْرَاهِيمَ<br>
                إِنَّكَ حَمِيدٌ مَجِيدٌ
            </div>
        </div>
        <p class="subtitle">Create beautiful book collages with highlighting</p>
        
        <!-- Search Bar -->
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search books..." oninput="searchBooks()">
            <span class="search-icon">🔍</span>
        </div>
        
        <h2 style="color: #667eea; margin-bottom: 15px; font-size: 1.3em;">Available Books</h2>
        <div id="booksList" class="books-list">
            <div class="loading">
                <div class="loading-spinner"></div>
                Loading books...
            </div>
        </div>
        
        <div id="volumesSection" class="hidden">
            <h3 style="color: #667eea; margin-bottom: 10px;">Select Volume</h3>
            <div id="volumesList" class="volumes-list"></div>
        </div>
        
        <div id="errorContainer"></div>
        
        <div id="collageSettings" class="collage-settings hidden">
            <div class="setting-group">
                <label>How many pages do you want in your collage?</label>
                <div class="page-count-btns">
                    <button class="page-count-btn active" onclick="setPageCount(2)">2 Pages</button>
                    <button class="page-count-btn" onclick="setPageCount(3)">3 Pages</button>
                    <button class="page-count-btn" onclick="setPageCount(4)">4 Pages</button>
                </div>
            </div>
            
            <div class="setting-group">
                <label>Select page numbers:</label>
                <div id="pageInputs" class="page-inputs"></div>
            </div>
            
            <p class="info-text" id="pageInfo"></p>
        </div>
        
        <div id="highlightSection" class="highlight-controls hidden">
            <h3 style="color: #667eea; margin-bottom: 10px; text-align: center;">Highlight Text</h3>
            <div class="highlight-colors">
                <div class="color-btn highlight-yellow active" data-color="#ffff00" onclick="setHighlightColor(this)"></div>
                <div class="color-btn highlight-red" data-color="#ff0000" onclick="setHighlightColor(this)"></div>
                <div class="color-btn highlight-cyan" data-color="#00ffff" onclick="setHighlightColor(this)"></div>
                <div class="color-btn highlight-lime" data-color="#00ff00" onclick="setHighlightColor(this)"></div>
            </div>
            <p class="highlight-instructions">
                Click/tap and drag to create highlights. Click on existing highlights to resize them.
            </p>
            <div class="highlight-actions">
                <button class="action-btn undo-btn" id="undoBtn" onclick="undoHighlight()" disabled>↶ Undo</button>
                <button class="action-btn redo-btn" id="redoBtn" onclick="redoHighlight()" disabled>↷ Redo</button>
                <button class="action-btn clear-btn" onclick="clearHighlights()">Clear All</button>
                <button class="action-btn toggle-btn" id="toggleHighlightBtn" onclick="toggleHighlightMode()">Disable Highlighting</button>
            </div>
        </div>
        
        <div id="previewSection" class="preview-section hidden">
            <h2 style="color: #667eea; margin-bottom: 20px; font-size: 1.3em;">Preview</h2>
            <div class="preview-container">
                <canvas id="previewCanvas" class="preview-canvas"></canvas>
                <canvas id="highlightCanvas" class="highlight-canvas"></canvas>
            </div>
            <br>
            <button class="download-btn" onclick="downloadCollage()">💾 Download Collage</button>
        </div>
    </div>

    <script>
        // Correct PDF worker URL
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // Enhanced Book structure with publisher and language info
        const booksStructure = {
            // Single volume books (direct files)
            "single": [
                {
                    name: "المسند للشافعي",
                    file:"https://raw.githubusercontent.com/saadhusainn/sijjeen1/main/almusannaf/Mus.pdf",
                    publisher:"دار الكتب العلمية",
                    language:"العربية"
                },
                 {
                    name: "موطأ الإمام مالك برواية يحيى ت عبد الباقي",
                    file: "https://jkzrxmubfuyhuwlbpfoj.supabase.co/storage/v1/object/public/sijjeen1/Muwatta%20bi-riwayat%20Yahya%20T%20abd%20al-baqi.pdf",
                    publisher: "دار احياء التراث للعربي",
                    language: "العربية"
                },
            ],
            // Multi-volume books (organized in folders)
            "multi": [
                { 
                    name: "المصنف لعبد الرزاق", 
                    folder: "https://jkzrxmubfuyhuwlbpfoj.supabase.co/storage/v1/object/public/sijjeen1/Musannaf%20abd%20al-razzaq%20dar%20al-ta'sil/",
                    volumes: 10,
                    pattern: "{vol}-6836.pdf",
                    publisher: "دار التأصيل",
                    language: "العربية"
                },
                { 
                    name: "مسند الحميدي", 
                    folder: "https://jkzrxmubfuyhuwlbpfoj.supabase.co/storage/v1/object/public/sijjeen1/Musnad%20humaydi/",
                    volumes: 2,
                    pattern: "mh{vol}.pdf",
                    publisher: "دار المامون للتراث",
                    language: "العربية"
                },
                { 
                    name: "المصنف لعبد الرزاق", 
                    folder: "https://jkzrxmubfuyhuwlbpfoj.supabase.co/storage/v1/object/public/sijjeen1/Musannaf%20abd%20al-razzaq%20maktabah%20al%20islami/",
                    volumes: 13,
                    pattern: "miar{vol}.pdf",
                    publisher: "مكتبة الإسلامي",
                    language: "العربية"
                },
                { 
                    name: "المصنف لعبد الرزاق", 
                    folder: "https://jkzrxmubfuyhuwlbpfoj.supabase.co/storage/v1/object/public/sijjeen1/Musannaf%20abd%20al-razzaq%20urdu/",
                    volumes: 6,
                    pattern: "mar{vol}.pdf",
                    publisher: "N/A",
                    language: "أردو"
                },
                { 
                    name: "مسند أبي يعلى الموصيلي", 
                    folder: "https://jkzrxmubfuyhuwlbpfoj.supabase.co/storage/v1/object/public/sijjeen1/Musnad%20abi%20ya'la%20dar%20al-ma'mun/",
                    volumes: 14,
                    pattern: "mayala{vol}.pdf",
                    publisher: "دار المامون للتراث",
                    language: "العربية"
                },
                { 
                    name: "الطبقات الكبرى لابن سعد", 
                    folder: "https://jkzrxmubfuyhuwlbpfoj.supabase.co/storage/v1/object/public/sijjeen1/Tabaqat%20ibn%20sa'd%20maktabah%20al-khanji/",
                    volumes: 11,
                    pattern: "A66aba9at_{vol}.pdf",
                    publisher: "مكتبة الخانجي",
                    language: "العربية"
                },
                { 
                    name: "المعجم الكبير للطبراني", 
                    folder: "https://jkzrxmubfuyhuwlbpfoj.supabase.co/storage/v1/object/public/sijjeen1/Mujam%20al%20Kabir%20maktabah%20Ibn%20tamiyah/",
                    volumes: 25,
                    pattern: "mtk{vol}.pdf",
                    publisher: "مكتبة ابن تيمية",
                    language: "العربية"
                },
                { 
                    name: "المصنف لابن أبي شيبة ت الشثري", 
                    folder: "https://jkzrxmubfuyhuwlbpfoj.supabase.co/storage/v1/object/public/sijjeen1/Musannaf%20Ibn%20abi%20shaybah%20dar%20kunuz/",
                    volumes: 25,
                    pattern: "{vol}_152371.pdf",
                    publisher: "دار كنوز",
                    language: "العربية"
                },
                { 
                    name: "السنن الكبرى للنسائي", 
                    folder: "https://jkzrxmubfuyhuwlbpfoj.supabase.co/storage/v1/object/public/sijjeen1/Sunan%20kubra%20nasai%20al-risalah/",
                    volumes: 12,
                    pattern: "snk{vol}.pdf",
                    publisher: "المكتبة الرسالة",
                    language: "العربية"
                },
                { 
                    name: "المعجم الصغير للطبراني", 
                    folder: "https://jkzrxmubfuyhuwlbpfoj.supabase.co/storage/v1/object/public/sijjeen1/Mujam%20al-Saghir%20al-ilmiyyah/",
                    volumes: 2,
                    pattern: "mst{vol}.pdf",
                    publisher: "دار الكتب العلمية",
                    language: "العربية"
                },
                { 
                    name: "المعجم الأوسط للطبراني", 
                    folder: "https://jkzrxmubfuyhuwlbpfoj.supabase.co/storage/v1/object/public/sijjeen1/Mujam%20al-awsat%20dar%20al-haramayn/",
                    volumes: 10,
                    pattern: "mat{vol}.pdf",
                    publisher: "دار الحرمين",
                    language: "العربية"
                },
                 { 
                    name: "مسند أبي داود الطيالسي", 
                    folder: "https://jkzrxmubfuyhuwlbpfoj.supabase.co/storage/v1/object/public/sijjeen1/Musnad%20abi%20dawud%20al-tayalisi%20dar%20hijr/",
                    volumes: 4,
                    pattern: "mad{vol}.pdf",
                    publisher: "دار هجر",
                    language: "العربية"
                },
                 { 
                    name: "مسند أحمد ت شاكر", 
                    folder: "https://jkzrxmubfuyhuwlbpfoj.supabase.co/storage/v1/object/public/sijjeen1/Musnad%20ahmad%20T%20shakir%20dar%20al-hadith/",
                    volumes: 18,
                    pattern: "musnda{vol}.pdf",
                    publisher: "دار الحديث",
                    language: "العربية"
                },
                 { 
                    name: "البحر الزخار المعروف بمسند البزار", 
                    folder: "https://jkzrxmubfuyhuwlbpfoj.supabase.co/storage/v1/object/public/sijjeen1/Musnad%20al-bazzar%20maktabah%20al-ulum/",
                    volumes: 15,
                    pattern: "musbaz{vol}.pdf",
                    publisher: "مكتبة العلوم",
                    language: "العربية"
                },
                 { 
                    name: "المستدرك على الصحيحين للحاكم", 
                    folder: "https://jkzrxmubfuyhuwlbpfoj.supabase.co/storage/v1/object/public/sijjeen1/Mustadrak%20al-hakim%20al-ilmiyyah/",
                    volumes: 5,
                    pattern: "{vol}.pdf",
                    publisher: "دار الكتب العلمية",
                    language: "العربية"
                },
                 { 
                    name: "موطأ الإمام مالك رواية أبي مصعب الزهري", 
                    folder: "https://jkzrxmubfuyhuwlbpfoj.supabase.co/storage/v1/object/public/sijjeen1/Muwatta%20malik%20bi-riwayat%20abi%20mus'ab%20al-zuhri%20dal%20ta'sil/",
                    volumes: 3,
                    pattern: "mm{vol}.pdf",
                    publisher: "دار التأصيل",
                    language: "العربية"
                },
                 { 
                    name: "شعب الإيمان ت الزغلول", 
                    folder: "https://jkzrxmubfuyhuwlbpfoj.supabase.co/storage/v1/object/public/sijjeen1/Shu'b%20al-iman%20T%20al-Zhughlul%20al-ilmiyyah/",
                    volumes: 9,
                    pattern: "gshe_elmiya{vol}.pdf",
                    publisher: "دار الكتب العلمية",
                    language: "العربية"
                },
                 { 
                    name: "السنن الكبرى للبيهقى", 
                    folder: "https://jkzrxmubfuyhuwlbpfoj.supabase.co/storage/v1/object/public/sijjeen1/Sunan%20kubra%20al-bayhaqi%20al-ilmiyyah/",
                    volumes: 11,
                    pattern: "skb{vol}.pdf",
                    publisher: "دار الكتب العلمية",
                    language: "العربية"
                }
            ]
        };
        
        let books = [];
        let selectedBook = null;
        let pageCount = 2;
        let highlights = [];
        let highlightHistory = [];
        let historyIndex = -1;
        let currentHighlightColor = "#ffff00";
        let isHighlightMode = true;
        let isDrawing = false;
        let currentRect = null;
        let startX, startY;
        let selectedRectIndex = -1;
        let isResizing = false;
        let resizeHandle = -1;
        let canvasScale = 1;
        let previewTimeout = null;
        let pdfDocument = null;

        async function loadBooks() {
            try {
                // Show loading animation
                const list = document.getElementById('booksList');
                list.innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading books...
                    </div>
                `;
                
                // Simulate loading delay for better UX
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Load single volume books
                booksStructure.single.forEach(book => {
                    books.push({
                        ...book,
                        type: 'single'
                    });
                });
                
                // Load multi-volume books
                booksStructure.multi.forEach(book => {
                    books.push({
                        ...book,
                        type: 'multi'
                    });
                });
                
                displayBooks(books);
            } catch (error) {
                showError('Error loading books structure.');
            }
        }
        
        function searchBooks() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = books.filter(book => 
                book.name.toLowerCase().includes(query) ||
                (book.publisher && book.publisher.toLowerCase().includes(query)) ||
                (book.language && book.language.toLowerCase().includes(query))
            );
            displayBooks(filtered);
        }
        
        function showError(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `<div class="error-message">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
        
        function showSuccess(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `<div class="success-message">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }
        
        function displayBooks(booksToDisplay) {
            const list = document.getElementById('booksList');
            list.innerHTML = '';
            
            if (booksToDisplay.length === 0) {
                list.innerHTML = '<div class="no-results">No books found matching your search</div>';
                return;
            }
            
            booksToDisplay.forEach((book) => {
                const item = document.createElement('div');
                item.className = 'book-item';
                
                if (book.type === 'multi') {
                    item.classList.add('book-folder');
                    let metaHTML = '';
                    if (book.publisher || book.language) {
                        metaHTML = `<div class="book-meta">`;
                        if (book.publisher) metaHTML += `<strong>الناشر:</strong> ${book.publisher}<br>`;
                        if (book.language) metaHTML += `<strong>اللغة:</strong> ${book.language}`;
                        metaHTML += `</div>`;
                    }
                    
                    item.innerHTML = `
                        📁 ${book.name}
                        <span class="volume-count">(${book.volumes} volumes)</span>
                        ${metaHTML}
                    `;
                } else {
                    let metaHTML = '';
                    if (book.publisher || book.language) {
                        metaHTML = `<div class="book-meta">`;
                        if (book.publisher) metaHTML += `<strong>الناشر:</strong> ${book.publisher}<br>`;
                        if (book.language) metaHTML += `<strong>اللغة:</strong> ${book.language}`;
                        metaHTML += `</div>`;
                    }
                    
                    item.innerHTML = `
                        📄 ${book.name}
                        ${metaHTML}
                    `;
                }
                
                item.onclick = () => selectBook(book);
                list.appendChild(item);
            });
        }
        
        function selectBook(book) {
            selectedBook = book;
            
            const items = document.querySelectorAll('.book-item');
            items.forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.book-item').classList.add('selected');
            
            if (book.type === 'multi') {
                showVolumes(book);
            } else {
                document.getElementById('volumesSection').classList.add('hidden');
                loadBookFile(book.file, book.name);
            }
        }
        
        function showVolumes(book) {
            const volumesSection = document.getElementById('volumesSection');
            const volumesList = document.getElementById('volumesList');
            
            volumesList.innerHTML = '';
            
            // Generate volume list
            for (let i = 1; i <= book.volumes; i++) {
                const volumeNumber = i.toString().padStart(2, '0');
                const volumeFile = book.pattern.replace('{vol}', volumeNumber);
                const volumeItem = document.createElement('div');
                volumeItem.className = 'volume-item';
                
                let metaHTML = '';
                if (book.publisher || book.language) {
                    metaHTML = `<div class="book-meta" style="font-size: 0.7em; margin-top: 3px;">`;
                    if (book.publisher) metaHTML += `<strong>الناشر:</strong> ${book.publisher}<br>`;
                    if (book.language) metaHTML += `<strong>اللغة:</strong> ${book.language}`;
                    metaHTML += `</div>`;
                }
                
                volumeItem.innerHTML = `
                    📖 Volume ${i}
                    ${metaHTML}
                `;
                
                volumeItem.onclick = () => {
                    document.querySelectorAll('.volume-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    volumeItem.classList.add('selected');
                    
                    const filePath = book.folder + volumeFile;
                    loadBookFile(filePath, `${book.name} - Volume ${i}`);
                };
                volumesList.appendChild(volumeItem);
            }
            
            volumesSection.classList.remove('hidden');
            document.getElementById('collageSettings').classList.add('hidden');
        }
        
        async function loadBookFile(filePath, displayName) {
            try {
                // Show loading animation
                const container = document.getElementById('errorContainer');
                container.innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading book metadata...
                    </div>
                `;
                
                // Load only the PDF document metadata first (fast)
                pdfDocument = await pdfjsLib.getDocument(filePath).promise;
                
                selectedBook = {
                    ...selectedBook,
                    pdf: pdfDocument,
                    displayName: displayName
                };
                
                document.getElementById('pageInfo').textContent = `This book has ${pdfDocument.numPages} pages`;
                document.getElementById('collageSettings').classList.remove('hidden');
                
                // Automatically show page inputs when book loads
                updatePageInputs();
                
                // Auto-generate preview with first pages
                await updatePreview();
                
                showSuccess('✅ Book loaded successfully! Preview generated automatically.');
                
            } catch (error) {
                showError(`Error loading book: ${error.message}. Please check if the file exists.`);
            }
        }
        
        function setPageCount(count) {
            pageCount = count;
            
            const buttons = document.querySelectorAll('.page-count-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            updatePageInputs();
            // Auto-update preview when page count changes
            debouncedUpdatePreview();
        }
        
        function updatePageInputs() {
            if (!selectedBook || !selectedBook.pdf) return;
            
            const container = document.getElementById('pageInputs');
            container.innerHTML = '';
            
            for (let i = 1; i <= pageCount; i++) {
                const group = document.createElement('div');
                group.className = 'page-input-group';
                
                const label = document.createElement('span');
                label.textContent = `Page ${i}:`;
                
                const input = document.createElement('input');
                input.type = 'number';
                input.id = `page${i}`;
                input.min = '1';
                input.max = selectedBook.pdf.numPages;
                input.value = i;
                input.oninput = debouncedUpdatePreview; // Live preview on input change
                
                group.appendChild(label);
                group.appendChild(input);
                container.appendChild(group);
            }
        }
        
        // Debounce function to prevent too many preview updates
        function debouncedUpdatePreview() {
            if (previewTimeout) {
                clearTimeout(previewTimeout);
            }
            previewTimeout = setTimeout(() => {
                updatePreview();
            }, 500); // 500ms delay
        }
        
        async function updatePreview() {
            if (!selectedBook || !selectedBook.pdf) return;
            
            try {
                const pageNumbers = [];
                for (let i = 1; i <= pageCount; i++) {
                    const input = document.getElementById(`page${i}`);
                    if (!input) continue;
                    
                    const pageNum = parseInt(input.value);
                    if (isNaN(pageNum) || pageNum < 1 || pageNum > selectedBook.pdf.numPages) {
                        // Don't show error for live updates, just skip invalid pages
                        continue;
                    }
                    pageNumbers.push(pageNum);
                }
                
                // Skip if no valid page numbers
                if (pageNumbers.length === 0) return;
                
                // Show loading for specific pages only
                showSuccess(`Loading pages: ${pageNumbers.join(', ')}...`);
                
                const pages = [];
                // Load only the specific pages needed (optimized loading)
                for (let pageNum of pageNumbers) {
                    const page = await selectedBook.pdf.getPage(pageNum);
                    pages.push(page);
                }
                
                // MAXIMUM QUALITY: Increased scale for higher resolution
                const scale = 4; // Increased from 2 to 4 for maximum quality
                const viewports = pages.map(page => page.getViewport({scale}));
                
                const canvas = document.getElementById('previewCanvas');
                const ctx = canvas.getContext('2d');
                
                const totalWidth = viewports.reduce((sum, vp) => sum + vp.width, 0);
                const maxHeight = Math.max(...viewports.map(vp => vp.height));
                
                // Set canvas to high resolution
                canvas.width = totalWidth;
                canvas.height = maxHeight;
                
                // Calculate display scale for screen (different from render scale)
                const maxDisplayWidth = Math.min(window.innerWidth - 40, 1200);
                canvasScale = maxDisplayWidth / totalWidth;
                
                canvas.style.width = totalWidth * canvasScale + 'px';
                canvas.style.height = maxHeight * canvasScale + 'px';
                
                // White background
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Render each page at maximum quality
                let xOffset = 0;
                for (let i = 0; i < pages.length; i++) {
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = viewports[i].width;
                    tempCanvas.height = viewports[i].height;
                    
                    await pages[i].render({
                        canvasContext: tempCanvas.getContext('2d'),
                        viewport: viewports[i]
                    }).promise;
                    
                    ctx.drawImage(tempCanvas, xOffset, 0);
                    xOffset += viewports[i].width;
                }
                
                // Set up highlight canvas
                const highlightCanvas = document.getElementById('highlightCanvas');
                highlightCanvas.width = canvas.width;
                highlightCanvas.height = canvas.height;
                highlightCanvas.style.width = canvas.style.width;
                highlightCanvas.style.height = canvas.style.height;
                
                // Preserve existing highlights
                drawHighlights();
                
                document.getElementById('previewSection').classList.remove('hidden');
                document.getElementById('highlightSection').classList.remove('hidden');
                
                setupHighlightCanvas();
                
                showSuccess(`✅ Preview updated with pages: ${pageNumbers.join(', ')}`);
                
            } catch (error) {
                console.error('Error updating preview:', error);
                showError('Error loading specific pages. Please check page numbers.');
            }
        }
        
        // Undo/Redo functionality for highlights
        function saveHighlightState() {
            // Remove any future states if we're not at the end of history
            highlightHistory = highlightHistory.slice(0, historyIndex + 1);
            
            // Save current state
            highlightHistory.push(JSON.parse(JSON.stringify(highlights)));
            historyIndex++;
            
            // Limit history size to prevent memory issues
            if (highlightHistory.length > 50) {
                highlightHistory.shift();
                historyIndex--;
            }
            
            updateUndoRedoButtons();
        }
        
        function undoHighlight() {
            if (historyIndex > 0) {
                historyIndex--;
                highlights = JSON.parse(JSON.stringify(highlightHistory[historyIndex]));
                drawHighlights();
                updateUndoRedoButtons();
            }
        }
        
        function redoHighlight() {
            if (historyIndex < highlightHistory.length - 1) {
                historyIndex++;
                highlights = JSON.parse(JSON.stringify(highlightHistory[historyIndex]));
                drawHighlights();
                updateUndoRedoButtons();
            }
        }
        
        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            
            undoBtn.disabled = historyIndex <= 0;
            redoBtn.disabled = historyIndex >= highlightHistory.length - 1;
        }
        
        function setupHighlightCanvas() {
            const canvas = document.getElementById('highlightCanvas');
            
            function getCanvasCoordinates(clientX, clientY) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                
                return {
                    x: (clientX - rect.left) * scaleX,
                    y: (clientY - rect.top) * scaleY
                };
            }
            
            function handleStart(x, y) {
                if (!isHighlightMode) return;
                
                for (let i = 0; i < highlights.length; i++) {
                    const h = highlights[i];
                    const handles = getResizeHandles(h);
                    
                    for (let j = 0; j < handles.length; j++) {
                        if (isPointInRect(x, y, handles[j])) {
                            isResizing = true;
                            resizeHandle = j;
                            selectedRectIndex = i;
                            return;
                        }
                    }
                    
                    if (isPointInRect(x, y, h)) {
                        selectedRectIndex = i;
                        isDrawing = false;
                        drawHighlights();
                        return;
                    }
                }
                
                isDrawing = true;
                startX = x;
                startY = y;
                currentRect = {
                    x: x,
                    y: y,
                    width: 0,
                    height: 0,
                    color: currentHighlightColor
                };
                highlights.push(currentRect);
                selectedRectIndex = highlights.length - 1;
                
                // Save state for undo/redo
                saveHighlightState();
            }
            
            function handleMove(x, y) {
                if (!isHighlightMode) return;
                
                if (isResizing && selectedRectIndex >= 0) {
                    const h = highlights[selectedRectIndex];
                    resizeRectangle(h, resizeHandle, x, y);
                    drawHighlights();
                    return;
                }
                
                if (isDrawing && currentRect) {
                    currentRect.width = x - startX;
                    currentRect.height = y - startY;
                    drawHighlights();
                }
            }
            
            function handleEnd() {
                if (isDrawing || isResizing) {
                    // Save final state after drawing/resizing
                    saveHighlightState();
                }
                isDrawing = false;
                isResizing = false;
                resizeHandle = -1;
            }
            
            canvas.onmousedown = (e) => {
                const coords = getCanvasCoordinates(e.clientX, e.clientY);
                handleStart(coords.x, coords.y);
            };
            
            canvas.onmousemove = (e) => {
                const coords = getCanvasCoordinates(e.clientX, e.clientY);
                handleMove(coords.x, coords.y);
            };
            
            canvas.onmouseup = handleEnd;
            
            canvas.ontouchstart = (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const coords = getCanvasCoordinates(touch.clientX, touch.clientY);
                handleStart(coords.x, coords.y);
            };
            
            canvas.ontouchmove = (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const coords = getCanvasCoordinates(touch.clientX, touch.clientY);
                handleMove(coords.x, coords.y);
            };
            
            canvas.ontouchend = (e) => {
                e.preventDefault();
                handleEnd();
            };
        }
        
        function isPointInRect(x, y, rect) {
            return x >= rect.x && x <= rect.x + rect.width &&
                   y >= rect.y && y <= rect.y + rect.height;
        }
        
        function getResizeHandles(rect) {
            const size = 12;
            return [
                { x: rect.x - size/2, y: rect.y - size/2, width: size, height: size },
                { x: rect.x + rect.width - size/2, y: rect.y - size/2, width: size, height: size },
                { x: rect.x - size/2, y: rect.y + rect.height - size/2, width: size, height: size },
                { x: rect.x + rect.width - size/2, y: rect.y + rect.height - size/2, width: size, height: size }
            ];
        }
        
        function resizeRectangle(rect, handleIndex, x, y) {
            switch(handleIndex) {
                case 0:
                    rect.width += rect.x - x;
                    rect.height += rect.y - y;
                    rect.x = x;
                    rect.y = y;
                    break;
                case 1:
                    rect.width = x - rect.x;
                    rect.height += rect.y - y;
                    rect.y = y;
                    break;
                case 2:
                    rect.width += rect.x - x;
                    rect.height = y - rect.y;
                    rect.x = x;
                    break;
                case 3:
                    rect.width = x - rect.x;
                    rect.height = y - rect.y;
                    break;
            }
            
            if (rect.width < 5) rect.width = 5;
            if (rect.height < 5) rect.height = 5;
        }
        
        function drawHighlights() {
            const canvas = document.getElementById('highlightCanvas');
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Set multiply blend mode for real-time preview
            ctx.globalCompositeOperation = 'multiply';
            
            // Draw all highlights with solid colors
            highlights.forEach((rect, index) => {
                ctx.fillStyle = rect.color;
                ctx.fillRect(rect.x, rect.y, rect.width, rect.height);
                
                // Draw resize handles for selected rectangle (only in preview, not in download)
                if (index === selectedRectIndex) {
                    const handles = getResizeHandles(rect);
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.fillStyle = '#000';
                    handles.forEach(handle => {
                        ctx.fillRect(handle.x, handle.y, handle.width, handle.height);
                    });
                    ctx.globalCompositeOperation = 'multiply';
                }
            });
            
            ctx.globalCompositeOperation = 'source-over';
        }
        
        function setHighlightColor(button) {
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');
            currentHighlightColor = button.getAttribute('data-color');
        }
        
        function clearHighlights() {
            if (highlights.length > 0) {
                saveHighlightState();
                highlights = [];
                selectedRectIndex = -1;
                drawHighlights();
            }
        }
        
        function toggleHighlightMode() {
            isHighlightMode = !isHighlightMode;
            const btn = document.getElementById('toggleHighlightBtn');
            btn.textContent = isHighlightMode ? 'Disable Highlighting' : 'Enable Highlighting';
            
            const canvas = document.getElementById('highlightCanvas');
            canvas.style.cursor = isHighlightMode ? 'crosshair' : 'default';
        }
        
        function downloadCollage() {
            try {
                const previewCanvas = document.getElementById('previewCanvas');
                const highlightCanvas = document.getElementById('highlightCanvas');
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                // Use maximum quality for download
                tempCanvas.width = previewCanvas.width;
                tempCanvas.height = previewCanvas.height;
                
                // Draw the preview at maximum quality
                tempCtx.drawImage(previewCanvas, 0, 0);
                
                // Draw highlights with multiply blend mode (NO resize handles in final download)
                tempCtx.globalCompositeOperation = 'multiply';
                
                // Redraw highlights without resize handles
                highlights.forEach(rect => {
                    tempCtx.fillStyle = rect.color;
                    tempCtx.fillRect(rect.x, rect.y, rect.width, rect.height);
                });
                
                // Generate safe filename
                const pageNumbers = [];
                for (let i = 1; i <= pageCount; i++) {
                    const input = document.getElementById(`page${i}`);
                    if (input) {
                        const pageNum = parseInt(input.value);
                        if (!isNaN(pageNum)) {
                            pageNumbers.push(pageNum);
                        }
                    }
                }
                
                const bookName = (selectedBook.displayName || selectedBook.name)
                    .replace(/[<>:"/\\|?*]/g, '') // Remove invalid filename characters
                    .replace(/\s+/g, '_') // Replace spaces with underscores
                    .substring(0, 50); // Limit length
                
                const volumeMatch = selectedBook.displayName?.match(/Volume\s+(\d+)/i);
                const volumeNum = volumeMatch ? volumeMatch[1] : '1';
                
                const pagesStr = pageNumbers.length > 0 ? `pg${pageNumbers.join('-')}` : 'pages';
                
                const now = new Date();
                const dateStr = now.toISOString()
                    .replace(/[:.]/g, '-')
                    .replace('T', '_')
                    .substring(0, 16);
                
                const filename = `${bookName}_vol${volumeNum}_${pagesStr}_${dateStr}.png`;
                
                const link = document.createElement('a');
                link.download = filename;
                link.href = tempCanvas.toDataURL('image/png', 1.0); // Maximum quality PNG
                link.click();
                
                showSuccess(`✅ Collage downloaded as: ${filename}`);
                
            } catch (error) {
                showError('Error downloading collage. Please try again.');
            }
        }
        
        // Initialize the application
        loadBooks();
    </script>
</body>
</html>
